---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import PostCard from '../../components/PostCard.astro';
import { tagToSlug } from '../../lib/tags';

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => import.meta.env.DEV || !data.draft);
	const slugs = new Set<string>();
	for (const post of posts) {
		for (const tag of post.data.tags) slugs.add(tagToSlug(tag));
	}
	return [...slugs].map((tag) => ({ params: { tag } }));
}

const tagSlug = Astro.params.tag ?? '';

const allPosts = await getCollection('blog', ({ data }) => import.meta.env.DEV || !data.draft);
const posts = allPosts.filter((post) => post.data.tags.some((t) => tagToSlug(t) === tagSlug));
posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const allTags = new Set(allPosts.flatMap((post) => post.data.tags));
const displayTag = [...allTags].find((t) => tagToSlug(t) === tagSlug) ?? tagSlug;
---

<Layout title={`Tag: ${displayTag}`} description={`Posts tagged “${displayTag}”.`}>
	<h1>Tag: {displayTag}</h1>
	<p class="lede">{posts.length} post{posts.length === 1 ? '' : 's'}</p>

	<ul class="list">
		{posts.map((post) => <PostCard post={post} />)}
	</ul>
</Layout>

<style>
	.lede {
		margin: 0 0 18px;
		color: var(--muted);
	}

	.list {
		display: grid;
		gap: 12px;
		padding: 0;
		margin: 0;
	}
</style>

